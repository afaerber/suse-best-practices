<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 [
<!ENTITY % entity SYSTEM "entity-decl.ent">
%entity;
<!ENTITY tenstorrent "Tenstorrent">
]>
<sect1 version="5.0" xmlns="http://docbook.org/ns/docbook"
       xmlns:xi="http://www.w3.org/2001/XInclude"
       xmlns:xlink="http://www.w3.org/1999/xlink">
  <title>&tenstorrent;</title>
  <para>...</para>

  <sect2>
    <title>Installing a Kernel Module Package</title>
    <para>As of version 6.10, the Linux kernel did not yet contain a device driver for &tenstorrent; PCIe cards.<footnote>
      <para>No file or directory at <link xlink:href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/accel?h=v6.10"/></para>
    </footnote></para>
    <para>The author has packaged a driver here: <link xlink:href="https://build.opensuse.org/package/show/home:a_faerber:machinelearning/tenstorrent"/></para>
    <procedure>
      <step>
        <para>Add the following unofficial, unsupported package repository:</para>
<screen>&prompt.root;<command>zypper addrepo https://download.opensuse.org/repositories/home:/a_faerber:/machinelearning/<replaceable>SL_Micro_6.0</replaceable>/ AF_ML</command></screen>
      </step>
      <step>
        <para>Check the flavor of your running Linux kernel:</para>
<screen>&prompt.user;<command>uname -r</command>
<replaceable>6.4.0-1</replaceable>-default</screen>
      </step>
      <step>
        <para>Install the Kernel Module Package matching your kernel flavor:</para>
<screen>&prompt.root;<command>zypper in tenstorrent-kmp-<replaceable>default</replaceable></command></screen>
      </step>
      <step>
        <para>Force loading of the unsupported kernel module:</para>
<screen>&prompt.root;<command>modprobe --allow-unsupported tenstorrent</command></screen>
        <xi:include href="AI-warn-kernel-taint.xml"/>
      </step>
    </procedure>
  </sect2>

  <sect2>
    <title>Running TT-SMI</title>
    <para>...</para>
    <note>
      <para>The TT-SMI tool sends serial numbers of all discovered cards to a Tenstorrent server,
        in order to obtain latest software versions for them.<footnote>
          <para><link xlink:href="https://github.com/tenstorrent/tt-smi/issues/42"/></para>
        </footnote></para>
    </note>

    <procedure>
      <para>To build a container:</para>
      <step>
        <para>Prepare a <filename>Containerfile</filename> with the following contents:</para>
        <programlisting>FROM registry.opensuse.org/opensuse/bci/python:3.11

WORKDIR /app

RUN zypper --non-interactive addrepo https://download.opensuse.org/repositories/home:/a_faerber:/machinelearning/openSUSE_Factory_ARM/ AF_ML &amp;&amp; \
    zypper --non-interactive --gpg-auto-import-keys install --no-confirm python311-tt-smi

ENTRYPOINT [ "tt-smi" ]</programlisting>
      </step>
      <step>
        <para>Build a container named <literal>tt-smi</literal>:</para>
        <screen>&prompt.user;<command>podman build -t tt-smi .</command></screen>
      </step>
    </procedure>

    <procedure>
      <para>To run the container:</para>
      <step>
        <para>To list detected devices:</para>
        <screen>&prompt.user;<command>podman run --rm -it -v /dev/tenstorrent:/dev/tenstorrent --group-add=keep-groups tt-smi --list</command></screen>
        <note>
          <para>Argument <parameter class="command">--device=/dev/tenstorrent/<replaceable>0</replaceable></parameter> will be insufficient,
            leaving the directory owned by &rootuser; rather than <systemitem class="username">nobody</systemitem>.<footnote>
              <para><application>Luwen</application> tool <command>detect_test</command> calls
                <function>luwen_ref::detect_chips_fallible()</function> and thereby <function>detect_chips_options()</function> in
                <link xlink:href="https://github.com/tenstorrent/luwen/blob/v0.4.3/crates/luwen-ref/src/detect.rs"/>,
                which calls function <function>PciDevice::scan()</function> in
                <link xlink:href="https://github.com/tenstorrent/luwen/blob/v0.4.3/crates/ttkmd-if/src/lib.rs"/>.</para>
            </footnote></para>
          <para>In case filesystem access is limited by system group, the option <option>keep-groups</option> is needed.</para>
        </note>
      </step>
      <step>
        <para>To see the interactive text UI:</para>
        <screen>&prompt.user;<command>podman run --rm -it -v /dev/tenstorrent:/dev/tenstorrent --group-add=keep-groups tt-smi</command></screen>
      </step>
    </procedure>
  </sect2>
</sect1>
